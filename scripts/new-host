#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
Usage:
  ./scripts/new-host <hostname> [--from <existing-host>]

What it does:
  - Creates hosts/<hostname>/
  - Writes hosts/<hostname>/default.nix (either from a template, or copied from an existing host)
  - (Optionally) adds the host to flake.nix under nixosConfigurations as:  <hostname> = mkHost "<hostname>";

What it does NOT do:
  - It does NOT generate hardware-configuration.nix for you (must run on the target machine)

Next step on the new machine:
  sudo nixos-generate-config --show-hardware-config > hosts/<hostname>/hardware-configuration.nix
  sudo nixos-rebuild switch --flake .#<hostname>

Examples:
  ./scripts/new-host crucible-dev
  ./scripts/new-host crucible-dev --from nixos
EOF
}

if [[ $# -lt 1 ]]; then
  usage
  exit 1
fi

HOSTNAME=""
FROM_HOST=""

HOSTNAME="$1"
shift || true

while [[ $# -gt 0 ]]; do
  case "$1" in
    --from)
      shift
      FROM_HOST="${1:-}"
      if [[ -z "$FROM_HOST" ]]; then
        echo "Error: --from requires a host name (e.g. --from nixos)" >&2
        exit 1
      fi
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown argument: $1" >&2
      usage
      exit 1
      ;;
  esac
done

# Basic validation
if ! [[ "$HOSTNAME" =~ ^[a-zA-Z0-9][a-zA-Z0-9-]*$ ]]; then
  echo "Error: invalid hostname '$HOSTNAME' (use letters/numbers/dashes, starting with a letter/number)" >&2
  exit 1
fi

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
HOST_DIR="${REPO_ROOT}/hosts/${HOSTNAME}"
DEFAULT_NIX="${HOST_DIR}/default.nix"
HW_NIX="${HOST_DIR}/hardware-configuration.nix"
FLAKE_NIX="${REPO_ROOT}/flake.nix"

mkdir -p "${HOST_DIR}"

if [[ -f "${DEFAULT_NIX}" ]]; then
  echo "Error: ${DEFAULT_NIX} already exists" >&2
  exit 1
fi

# Build default.nix
if [[ -n "${FROM_HOST}" ]]; then
  FROM_FILE="${REPO_ROOT}/hosts/${FROM_HOST}/default.nix"
  if [[ ! -f "${FROM_FILE}" ]]; then
    echo "Error: --from host '${FROM_HOST}' not found at ${FROM_FILE}" >&2
    exit 1
  fi
  cp "${FROM_FILE}" "${DEFAULT_NIX}"
else
  cat > "${DEFAULT_NIX}" <<EOF
{ inputs, ... }:

{
  imports = [
    ../../modules/system/base.nix
    ../../modules/system/desktop.nix
    ../../modules/system/gaming.nix

    # Hardware config for this host (generate on the machine):
    ./hardware-configuration.nix

    # Niri NixOS module
    inputs.niri.nixosModules.niri
  ];
}
EOF
fi

# Ensure the new host file prefers in-repo hardware config
# If copied from another host, replace any /etc fallback line with ./hardware-configuration.nix (keep comment style simple)
if grep -q "/etc/nixos/hardware-configuration.nix" "${DEFAULT_NIX}"; then
  perl -0777 -i -pe 's@^\s*/etc/nixos/hardware-configuration\.nix\s*$@    ./hardware-configuration.nix@mg' "${DEFAULT_NIX}"
fi

# Touch placeholder hardware config file (so the path exists)
if [[ ! -f "${HW_NIX}" ]]; then
  cat > "${HW_NIX}" <<'EOF'
# Generate this file ON THE TARGET MACHINE with:
#   sudo nixos-generate-config --show-hardware-config > hosts/<hostname>/hardware-configuration.nix
#
# This placeholder exists so the import path is valid in the repo.
{ ... }:
{
}
EOF
fi

# Add to flake.nix if possible
if [[ -f "${FLAKE_NIX}" ]]; then
  if grep -qE "^\s*${HOSTNAME}\s*=\s*mkHost\s*\"${HOSTNAME}\";" "${FLAKE_NIX}"; then
    echo "flake.nix already contains an entry for ${HOSTNAME}"
  else
    # Insert right after 'nixosConfigurations = {' line
    if grep -q "nixosConfigurations = {" "${FLAKE_NIX}"; then
      perl -i -pe 'if($.==1){$found=0} if(/nixosConfigurations\s*=\s*\{\s*$/ && !$found){$found=1; $_ .= "        '"${HOSTNAME}"' = mkHost \"'"${HOSTNAME}"'\";\n";} ' "${FLAKE_NIX}"
      echo "Added ${HOSTNAME} to flake.nix nixosConfigurations."
    else
      echo "Warning: could not find 'nixosConfigurations = {' in flake.nix. Please add:" >&2
      echo "  ${HOSTNAME} = mkHost \"${HOSTNAME}\";" >&2
    fi
  fi
fi

echo ""
echo "Created host scaffold:"
echo "  ${DEFAULT_NIX}"
echo "  ${HW_NIX}"
echo ""
echo "Next on the '${HOSTNAME}' machine:"
echo "  cd ${REPO_ROOT}"
echo "  sudo nixos-generate-config --show-hardware-config > hosts/${HOSTNAME}/hardware-configuration.nix"
echo "  sudo nixos-rebuild switch --flake .#${HOSTNAME}"
